<script>
  // Elements
  const track = document.querySelector('.carousel-track');
  const slides = Array.from(track.children);
  const prevButton = document.querySelector('.carousel-button.prev');
  const nextButton = document.querySelector('.carousel-button.next');
  const nav = document.querySelector('.carousel-nav');
  const carousel = document.querySelector('.carousel');

  let currentIndex = 0;
  let autoPlayInterval = null;

  // Show/hide arrows
  if (!showArrows) {
    prevButton.style.display = "none";
    nextButton.style.display = "none";
  }

  // Prepare captions from data- attributes + per-slide toggle
  slides.forEach((slide) => {
    const link = slide.querySelector("a");
    const captionDiv = slide.querySelector(".caption");
    const title = link.getAttribute("data-title");
    const subtitle = link.getAttribute("data-subtitle");
    const captionToggle = (link.getAttribute("data-caption") || "on").toLowerCase();

    if (title) captionDiv.querySelector("h2").textContent = title;
    if (subtitle) captionDiv.querySelector("p").textContent = subtitle;

    const hasContent = !!(title || subtitle);
    captionDiv.dataset.enabled = (captionToggle !== "off" && hasContent) ? "true" : "false";
    captionDiv.style.opacity = "0"; // default hidden; active slide will fade in
  });

  // Build thumbnails
  slides.forEach((slide, i) => {
    const thumbSrc = slide.querySelector("img").src;
    const thumb = document.createElement("img");
    thumb.src = thumbSrc;
    thumb.alt = `Thumbnail ${i+1}`;
    thumb.loading = "lazy";
    if (i === 0) thumb.classList.add('active');

    thumb.addEventListener("click", () => {
      currentIndex = i;
      updateCarousel();
      stopAutoPlay();
      startAutoPlay();
    });

    nav.appendChild(thumb);
  });

  const thumbnails = Array.from(nav.children);

  function updateCarousel(){
    const slideWidth = slides[0].getBoundingClientRect().width;
    track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;

    thumbnails.forEach((t, idx) => {
      if (idx === currentIndex) t.classList.add('active');
      else t.classList.remove('active');
    });

    thumbnails[currentIndex].scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});

    // Fade captions only for active + enabled slide
    slides.forEach((s, idx) => {
      const cap = s.querySelector(".caption");
      const enabled = cap.dataset.enabled === "true";
      cap.style.opacity = (idx === currentIndex && enabled) ? "1" : "0";
    });
  }

  function goToPrev(){ 
    currentIndex = (currentIndex - 1 + slides.length) % slides.length;
    updateCarousel();
    stopAutoPlay();
    startAutoPlay();
  }
  function goToNext(){ 
    currentIndex = (currentIndex + 1) % slides.length;
    updateCarousel();
    stopAutoPlay();
    startAutoPlay();
  }

  prevButton.addEventListener('click', goToPrev);
  nextButton.addEventListener('click', goToNext);

  // Autoplay
  function startAutoPlay(){ stopAutoPlay(); autoPlayInterval = setInterval(goToNext, slideDuration); }
  function stopAutoPlay(){ if (autoPlayInterval) clearInterval(autoPlayInterval); autoPlayInterval = null; }
  startAutoPlay();

  // Pause on hover
  if (pauseOnHover){
    carousel.addEventListener("mouseenter", stopAutoPlay);
    carousel.addEventListener("mouseleave", startAutoPlay);
  }

  // Touch swipe
  let startX=0,endX=0;
  carousel.addEventListener("touchstart",e=>{ startX=e.touches[0].clientX; stopAutoPlay(); });
  carousel.addEventListener("touchmove",e=>{ endX=e.touches[0].clientX; });
  carousel.addEventListener("touchend",()=>{
    const diff = startX - endX;
    if (Math.abs(diff) > 50){ diff > 0 ? goToNext() : goToPrev(); }
    startAutoPlay();
  });

  // Keyboard
  document.addEventListener("keydown",e=>{
    if(e.key==="ArrowLeft") goToPrev();
    if(e.key==="ArrowRight") goToNext();
  });

  // Recalculate on resize
  window.addEventListener("resize", updateCarousel);

  // Initial paint
  window.addEventListener("load", updateCarousel);
</script>
